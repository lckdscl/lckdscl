<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1.5">
<title>Barcode Time Test</title>
<style>
	body {
		background-color: #000;
		font-family: sans-serif;
		font-size: 80%;
		color: #fff;
		margin: 0;
		padding: 0;
	}
	label, input {
	margin: 0.5em;
	display: block;
	}
	.interesting {
		font-weight: bold;
		}
	#max {
		background-color: #ddf;
	}
	.barcode {
		display:block;
		margin: 0 auto;
		}
	.barcode-container {
		background-color: #fff;
		margin: 100% 0 0 0;
		height: 7.3cm;
		width: 7.3cm;
	}
	.test-result {
		margin-top: 0.5cm;
		color: #000;
	}
	#results {
		margin-top: 100%;
	}
	#test1 img{
		width: 2.84cm;
	}
	#test3 img{
		width: 3.08cm;
	}
	#test4 img{
		width: 3.31cm;
	}
	#test5 img{
		width: 3.54cm;
	}
	#test6 img{
		width: 2.84cm;
	}

</style>


</head>
<body>
	<label for="triggerBin">Trigger on Bin:</label>
    <input id="triggerBin" type="number" min="0" max="512" step="1" value="4"/>
	<label for="limit">Trigger Limit:</label>
	<input id="limit" type="number" min="0" max="128" step="1" value="20"/>
	<input id="startMeasurement" type="button" value="Start measurement"/>

	<div class="barcode-container" id="test1">
	<img src="images/Ticket_49FullFormat_23ErrorCorr_4scaling.png" class="barcode" width="200"/>
	<span class="test-result" id="test1-result"></span>
	</div>
	<div class="barcode-container" id="test3">
	<img src="images/Ticket_53FullFormat_23ErrorCorr_4scaling.png" class="barcode" width="200"/>
	<span class="test-result" id="test3-result"></span>
	</div>
	<div class="barcode-container" id="test4">
	<img src="images/Ticket_57FullFormat_23ErrorCorr_4scaling.png" class="barcode" width="200"/>
	<span class="test-result" id="test4-result"></span>
	</div>
	<div class="barcode-container" id="test5">
	<img src="images/Ticket_61FullFormat_23ErrorCorr_4scaling.png" class="barcode" width="200"/>
	<span class="test-result" id="test5-result"></span>
	</div>
	<div class="barcode-container" id="test6">
	<img src="images/Ticket_49FullFormat_23ErrorCorr_5scaling.png" class="barcode" width="200"/>
	<span class="test-result" id="test6-result"></span>
	</div>
	<table id="results">
		<tr><th>Test ID</th><th>Result(ms)</th></tr>	
	</table>
	
	<script type="text/javascript">

var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
var microphone_stream = null;
var analyser = audioCtx.createAnalyser();
analyser.fftSize = 1024;
var bufferLength = analyser.frequencyBinCount;
var dataArray = new Uint8Array(bufferLength);
var sums = new Array(bufferLength).fill(0);
var measurements = 0;
var triggerBin = 4;
var limit = 20;
var start, end;
var result;
var resultTable = document.getElementById("results");

function start_microphone(stream){
	microphone_stream = audioCtx.createMediaStreamSource(stream);
    microphone_stream.connect(analyser); 
};

navigator.mediaDevices.getUserMedia({audio:true})
.then(function(stream) {
	start_microphone(stream);
})
.catch(function(err) {
	alert('Error capturing audio.');
});

function getData(){
	requestAnimationFrame(getData);
	analyser.getByteFrequencyData(dataArray);
}

function checkTrigger() {
	analyser.getByteFrequencyData(dataArray);
	console.log(dataArray[triggerBin]);
	end = new Date();
	if(dataArray[triggerBin] > limit){
		var resultString = (end.getTime() - start.getTime()) + "ms";
		result.innerHTML = resultString;
		if(arguments.length>1){
			var args = Array.prototype.slice.call(arguments).slice(1);
			var row = document.createElement("tr");
			var cellTestId = document.createElement("td");
			var cellTestResult = document.createElement("td");
			cellTestId.innerHTML = arguments[0];
			cellTestResult.innerHTML = resultString;
			row.appendChild(cellTestId);
			console.log(cellTestResult);
			row.appendChild(cellTestResult);
			resultTable.appendChild(row);
			setTimeout(testBarcode, 2000, ...args);
		}
	} else {
		result.innerHTML = (end.getTime() - start.getTime()) + "ms";
		setTimeout(checkTrigger, 10, ...arguments);
	}
}

function testBarcode(){
	var id = arguments[0];
	console.log(arguments[0]);
	var barcode = document.getElementById(id);
	result = document.getElementById(id+"-result");
	start = new Date();
	barcode.scrollIntoView({behavior:"smooth"});
	checkTrigger(...arguments);
}

function calculateAverage() {
	analyser.getByteFrequencyData(dataArray);
	sums = sums.map(function (sum, index){
		return sum + dataArray[index];
	});
	measurements += 1;
	if(measurements < numMeasurements){
		setTimeout(calculateAverage, interval);
	} else {
		showResults();
	}
}

document.getElementById("startMeasurement").addEventListener('click', function(){
	triggerBin = document.getElementById("triggerBin").value;
	limit = document.getElementById("limit").value;
	getData();
	var testScenario = ["test1", "test3", "test4", "test5", "test6"];
	var testRun = testScenario.concat(testScenario, testScenario, testScenario, testScenario);
	testBarcode(...testRun);
});

</script>
	
</body>
</html>